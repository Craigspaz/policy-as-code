---
title: "Policy as Code Pipeline"
weight: 61
---

## Overview
This section will explore using policy as code tools to provide guardrails for IaC deployments. Policy as Code tools serve as gatekeepers to resource deployments that do not comply
with the policies an organization has established. There are many CI/CD tools that can be used to implement this workflow but for this workshop AWS CodePipeline will be used. The
concepts used here would be applicable to any CI/CD tool.

This pipeline will be used to deploy a compliant S3 bucket. Here is a typical policy that needs to be enforced:

>***AWS S3 buckets need to be deployed in a secure manner. We require encryption using strong and industry standard cryptography methods for data at rest and transit.
>There should be no public access and access should be restricted to the account that writes the data.***

An IaC developer will need to develop a set of rules to enforce the policy stated above. Here is a list of rules that will be used to enforce the policy above:
* ***Use S3 Block Public Access***
* ***Configure server-side encryption of S3 buckets***
* ***Use AWS managed keys for encryption of data in S3 bucket***
* ***Use a bucket policy to enforce HTTPS(TLS) connections only when reading or writing data***
* ***Use a bucket policy to enforce server-side encryption during object puts/writes to bucket***

AWS Cloud Development Kit (CDK) will be used to fix our S3 deployment. Review of the AWS Cloudformation templates that are generated by CDK will be explored as well as how they may be violating the rules that are written.

::alert[The AWS CodePipeline in this workshop is for educational and demo purposes only.]

## Getting Started
There are two options for running this part of the workshop:
* Running this workshop in your own AWS - [Using your own AWS account](/deployment/pipeline-integration#using-your-own-aws-account)
* Running a AWS Hosted Event - [AWS Hosted Event](/deployment/pipeline-integration#aws-hosted-event)

### Using your own AWS account
The environment needs to have the following tools installed.
1. [An AWS account](https://aws.amazon.com/getting-started/)
1. Setup AWS Cloud9 - [Create an environment](https://docs.aws.amazon.com/cloud9/latest/user-guide/tutorial-create-environment.html)
   * **Environment type** - Create a new no-ingress EC2 instance for environment (access via Systems Manager)
   * **Instance type** - Amazon Linux 2
1. Create a IAM role named **PolicyAsCodeRole** for configuring Cloud0 instance and deploying AWS CodePipeline [here](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_job-functions_create-policies.html) and select EC2 as the trusted entity. Choose the following AWS Managed Policies
   * AdministratorAccess
   * AWSCodeCommitPowerUser
   * AWSCodePipeline_ReadOnlyAccess
   * AWSCloud9SSMInstanceProfile
1. Attach the IAM role to the EC2 instance that has the prefix aws-cloud9-<**Name of the environment you've given it**>
1. Open your environment to Cloud9 specified [here](https://docs.aws.amazon.com/cloud9/latest/user-guide/open-environment.html)
1. Disable AWS managed temporary credentials in Cloud9 [settings](https://docs.aws.amazon.com/cloud9/latest/user-guide/security-iam.html#auth-and-access-control-temporary-managed-credentials).
1. Run the aws cli subcommand configure and leave everything blank but your region:
    ```
    aws configure
    AWS Access Key ID [None]: 
    AWS Secret Access Key [None]: 
    Default region name [None]: us-east-2 or whatever your actual region is.
    Default output format [None]:
    ```
1. Increase the volume size of your Cloud9 instance specified [here](https://docs.aws.amazon.com/cloud9/latest/user-guide/move-environment.html#move-environment-resize).
1. checkov - [Installing Checkov](/checkov/install-checkov)
1. cfn-guard - [Installing cfn-guard](https://github.com/aws-cloudformation/cloudformation-guard#installation)
1. Clone the policy-as-code repository from github in the environment directory:
    :::code{showCopyAction=true showLineNumbers=false}
    cd environment;git clone https://github.com/aws-samples/policy-as-code.git
    :::
1. Install the AWS CodePipeline as follows:
:::code{showCopyAction=true showLineNumbers=false}
cd ~/environment/policy-as-code/cdk/cicd
pip install -r requirements.txt
cdk bootstrap
cdk deploy --all
:::
13. Answer 'y' to all prompts.
1. Remove AdministratorAccess from the IAM role **PolicyAsCodeRole**.

### AWS Hosted Event
* Obtain the **Event Hash** for [AWS Event Engine](https://dashboard.eventengine.run/login)
* An AWS CodePipeline should be provisioned for you skip to the next section [AWS CodePipeline Run](/deployment/pipeline-integration#aws-codepipeline-run)

## AWS CodePipeline Run
The S3 application is ready to be deployed. In order for it to be deployed successfully it must comply with the rules created as specified above.
To kickoff the deployment use git push to AWS CodeCommit which is the source for the pipeline. During this workshop the CDK/CFN template will be
changed to comply with the rules specified in the AWS CodePipeline. Do the following:

1. Clone the workshop repo (If this is not already done.):
:::code{showCopyAction=true showLineNumbers=false}
cd ~/environment
git clone https://github.com/aws-samples/policy-as-code.git
:::
2. Remove the reference to the upstream code repo by issuing the command:
:::code{showCopyAction=true showLineNumbers=false}
git remote remove origin
:::
3. Get the repository clone URL by running the the following commands and adding it as our remote origin:
:::code{showCopyAction=true showLineNumbers=false}
export repo=$(aws codecommit list-repositories --output text | awk '{print $3}' | grep policy-as-code)
export codecommiturl=$(aws codecommit get-repository --repository-name ${repo} --query 'repositoryMetadata.cloneUrlHttp' --output text)
git remote add origin ${codecommiturl}
:::
4. Make sure that you have the git-remote-codecommit python package installed. This helps with authenticating with CodeCommit.
:::code{showCopyAction=true}
pip install git-remote-codecommit
:::
5. Push the repo
:::code{showCopyAction=true showLineNumbers=false}
git push --set-upstream origin main
:::
6. View the CodePipeline in your account. Instructions to do that is [here](https://docs.aws.amazon.com/codepipeline/latest/userguide/pipelines-view-console.html#pipelines-list-console.). Give it about a minute to restart. Initially the Pipeline will have failed because when deployed for the first time there was nothing in the CodeCommit repo.
7. Your CodePipeline will fail on the stage **ScanDeploy** stage. Click on the **Details** on the Scan - AWS CodeBuild.
![ScanDeployFailed](/static/ScanDeployFailed.png)
8. You'll get a pop box that looks like below. Click on **Link to execution details**:
![LinkExecutionDetail](/static/LinkExecutionDetails.png)
9. This should bring you to the CodeBuild project. The two failures look like this:
```
Check: CKV_AWS_53: "Ensure S3 bucket has block public ACLS enabled"
    FAILED for resource: AWS::S3::Bucket.Bucket83908E77
    File: /policy-as-code.template.json:3-50
    Guide: https://docs.bridgecrew.io/docs/bc_aws_s3_19

        3  |     "Bucket83908E77": {
        4  |       "Type": "AWS::S3::Bucket",
        5  |       "Properties": {
...
        29 |         "PublicAccessBlockConfiguration": {
        30 |           "BlockPublicAcls": false,
        31 |           "BlockPublicPolicy": true,
        32 |           "IgnorePublicAcls": true,
        33 |           "RestrictPublicBuckets": true
```
```
Check: CKV_AWS_19: "Ensure the S3 bucket has server-side-encryption enabled"
    FAILED for resource: AWS::S3::Bucket.Bucket83908E77
    File: /policy-as-code.template.json:3-50
    Guide: https://docs.bridgecrew.io/docs/s3_14-data-encrypted-at-rest

        3  |     "Bucket83908E77": {
        4  |       "Type": "AWS::S3::Bucket",
        5  |       "Properties": {
```
10. The S3 deployment is running into issues with checkov. The next section will look into fixing the issues and validating that S3 compliance with the checkov rules.

## Fixing CDK/CFN Template for Checkov rules violations
1. The two issues flagged by [checkov](https://github.com/bridgecrewio/checkov) are as follows:
    * CKV_AWS_53: "Ensure S3 bucket has block public ACLS enabled"
    * CKV_AWS_19: "Ensure the S3 bucket has server-side-encryption enabled"
1. To validate the same issue locally. Run the following commands:
   :::code{showCopyAction=true showLineNumbers=false}
   # Commands to setup CDK app locally, generate cfn template, and validate with checkov
   cd ~/environment/policy-as-code/cdk/app/
   pip install -r requirements.txt
   cdk synth
   checkov --directory cdk.out --config-file ./rules/checkov/checkov-config.yml
   :::
1. Verify that the same issues that checkov flagged in codebuild exists in the local environment.
1. CDK generated the CFN template that is in violation. Examine the CFN template by opening the file **cdk.out/policy-as-code.template.json** in the Cloud9 IDE:
    ![PolicyAsCodeTmpl](/static/PolicyAsCodeTmpl.png)
    Note the PublicAccessBlockConfiguration that checkov flagged:
    ```
    ...
    "PublicAccessBlockConfiguration": {
      "BlockPublicAcls": false,
      "BlockPublicPolicy": true,
      "IgnorePublicAcls": true,
      "RestrictPublicBuckets": true
    },
    ...
    ```
    The **BlockPublicAcls** has been set to **false** this needs to be **true**. To fix this go to the CDK source file that generated this template.
1. Open the file **s3_deployment.py** in the Cloud9's editor/IDE.
    ![S3DeploymentTree](/static/S3DeploymentTree.png)
    Find the section in the file that looks like this:
    ```
    ...
    block_public_access=aws_cdk.aws_s3.BlockPublicAccess(
        # Uncomment block_public_acls=True and remove block_public_acls=False
        # block_public_acls=True,
        block_public_acls=False,
        restrict_public_buckets=True,
        block_public_policy=True,
        ignore_public_acls=True
    )
    ...
    ```
    Here block_public_acls=False has been explicitly set. Remove that line and Uncomment the line of
    code above it. It will look like this:
    ```
    ...
    block_public_access=aws_cdk.aws_s3.BlockPublicAccess(
        # Uncomment block_public_acls=True and remove block_public_acls=False
        block_public_acls=True,
        restrict_public_buckets=True,
        block_public_policy=True,
        ignore_public_acls=True
    )
    ...
    ```
    Save the file in Cloud9 editor by clicking on **File**
    ![S3DeploymentFileSave.png](/static/S3DeploymentFileSave.png)
1. Run the following commands to see if the code change will fix this:
   :::code{showCopyAction=true showLineNumbers=false}
   cdk synth; checkov --directory cdk.out --config-file ./rules/checkov/checkov-config.yml
   :::
1. At this point there should only be one issue with checkov:
   ```
   ...
   Check: CKV_AWS_19: "Ensure the S3 bucket has server-side-encryption enabled"
        FAILED for resource: AWS::S3::Bucket.Bucket83908E77
        File: /policy-as-code.template.json:3-50
        Guide: https://docs.bridgecrew.io/docs/s3_14-data-encrypted-at-rest

                3  |     "Bucket83908E77": {
                4  |       "Type": "AWS::S3::Bucket",
                5  |       "Properties": {
   ...
   ```
1. The enabling encryption of data written to the S3 bucket. Open the file **cdk.out/policy-as-code.template.json** in Cloud9.
    ```
    ...
    "Bucket83908E77": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "LifecycleConfiguration": {...},
        "PublicAccessBlockConfiguration": {...},
        "Tags": [...],
        "VersioningConfiguration": {...}
      },
      "UpdateReplacePolicy": "Delete",
      "DeletionPolicy": "Delete",
      "Metadata": {
        "aws:cdk:path": "policy-as-code/Bucket/Resource"
      }
    }
    ...
    ```
    The property **BucketEncryption** is not set. Modify the CDK code to generate the CFN template that will set this property. Open the file **s3_deployment.py** and find the code that matches:
    ```
        ...
        # Uncommment to make checkov pass
        # encryption=aws_s3.BucketEncryption.S3_MANAGED,
        ...
    ```
    Uncomment **encryption=aws_s3.BucketEncryption.S3_MANAGED,** it should look like this:
    ```
        ...
        # Uncommment to make checkov pass
        encryption=aws_s3.BucketEncryption.S3_MANAGED,
        ...
    ```
    Save the file in Cloud9 and run:
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/cdk/app/; cdk synth
    :::
    Open the file **cdk.out/policy-as-code.template.json** and inspect the CFN template:
    ```
    ...
    "Bucket83908E77": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "LifecycleConfiguration": {...},
        "PublicAccessBlockConfiguration": {...},
        "Tags": [...],
        "VersioningConfiguration": {...}
      },
      "UpdateReplacePolicy": "Delete",
      "DeletionPolicy": "Delete",
      "Metadata": {
        "aws:cdk:path": "policy-as-code/Bucket/Resource"
      }
    }
    ...
    ```
    The CFN Template has the **BucketEncryption** property set.
1. Run checkov to validate the template:
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/cdk/app/;checkov --directory cdk.out --config-file ./rules/checkov/checkov-config.yml
    :::
    The output should look like this, with all 8 tests passing:
    ```
    cloudformation scan results:

    Passed checks: 8, Failed checks: 0, Skipped checks: 0

    Check: CKV_AWS_53: "Ensure S3 bucket has block public ACLS enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/bc_aws_s3_19

    Check: CKV_AWS_54: "Ensure S3 bucket has block public policy enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/bc_aws_s3_20

    Check: CKV_AWS_19: "Ensure the S3 bucket has server-side-encryption enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/s3_14-data-encrypted-at-rest

    Check: CKV_AWS_55: "Ensure S3 bucket has ignore public ACLs enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/bc_aws_s3_21

    Check: CKV_AWS_20: "Ensure the S3 bucket does not allow READ permissions to everyone"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/s3_1-acl-read-permissions-everyone

    Check: CKV_AWS_57: "Ensure the S3 bucket does not allow WRITE permissions to everyone"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/s3_2-acl-write-permissions-everyone

    Check: CKV_AWS_56: "Ensure S3 bucket has 'restrict_public_bucket' enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/bc_aws_s3_22

    Check: CKV_AWS_21: "Ensure the S3 bucket has versioning enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/s3_16-enable-versioning
    ``` 
1. Commit the changes to the repo and push to the source CodeCommit repo to kick of the pipeline.
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/;git commit -a -m "fix checkov violations in s3_deployment.py";git push
    :::
1. View the CodePipeline in your account. Instructions to do that is [here](https://docs.aws.amazon.com/codepipeline/latest/userguide/pipelines-view-console.html#pipelines-list-console.). Give it about a minute to restart. Verify that the checkov rules have passed but that the cfn-guard rules are now failing. Your CodePipeline will fail on the stage **ScanDeploy** stage. Click on the **Details** on the Scan - AWS CodeBuild.
    ![ScanDeployFailed](/static/ScanDeployFailed.png)
1. You'll get a pop box that looks like below. Click on **Link to execution details**:
    ![LinkExecutionDetail](/static/LinkExecutionDetails.png)
1. The S3 deployment is running into issues with cfn-guard. The next section will look into fixing the issues and validating that S3 compliance with the cfn-guard rules.




:::code{showCopyAction=true showLineNumbers=false}
cd ~/environment/policy-as-code/cdk/app/
:::

:::code{showCopyAction=true showLineNumbers=false}
        kms_key = aws_kms.Key(self, 'KmsKey',
            enable_key_rotation=True
        )
        
        kms_key.add_to_resource_policy(
            aws_iam.PolicyStatement(
                actions=[
                    '*',
                    'kms:*'
                ],
                effect=aws_iam.Effect.DENY,
                principals=[
                        aws_iam.AnyPrincipal()
                ],
                resources=[
                        "*"
                ],
                conditions={'StringNotEquals': {'kms:CallerAccount': self.account}}
            )
        )
:::

:::code{showCopyAction=true showLineNumbers=false}
        unencrypted_put_conditions = [
            {'StringNotEquals': { 's3:x-amz-server-side-encryption': 'AES256'}},
            {'StringNotEquals': { 's3:x-amz-server-side-encryption': 'aws:kms'}},
            {'Null': {'s3:x-amz-server-side-encryption': True}}
        ]
        
        for condition in unencrypted_put_conditions:
            bucket.add_to_resource_policy(
                aws_iam.PolicyStatement(
                    actions=[
                        "s3:PutObject"
                    ],
                    effect=aws_iam.Effect.DENY,
                    principals=[
                        aws_iam.AnyPrincipal()
                    ],
                    resources=[
                        bucket.bucket_arn + "/*"
                    ],
                    conditions=condition
                )
            )
:::



## Useful Markdown - Ignore
[Managing Polices](/advance-topics/managing-policies.html)
- Should we consolidate the validation process as one "stage" or segregate them to multiple. i.e running OPA and CFGuard as two separate stages, or a combination of rules(strict rule) as a stage, and additional optional rules as another stage.
- Using any of these tools within your own environment will probably require building a Docker Image for your CI/CD tools to use as a build image - how will you maintain and publish this docker image?
## Architecture Diagram
![pipeline.png](/static/pipeline.png)


## Building a custom pipeline stage
We will use CDK to create a custom pipeline stage and integrate it to a pipeline cdk construct. this can be added as a stage to an existing pipeline as well.
<br/>
We will create one stage for OPA and stage for CF Guard. lastly we will add the two custom stage in to a pipeline.
#### OPA Stage
```typescript
import {CdkPipeline, ShellScriptAction} from "@aws-cdk/pipelines";
import {Artifact} from "@aws-cdk/aws-codepipeline";

export const addOPAStage = (pipeline:CdkPipeline, sourceArtifact:Artifact) => {
  const OPAStage = pipeline.addStage('OPAStage');
  const shellScriptAction = new ShellScriptAction({
    actionName: "OPAalidation",
    commands: [
      'curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64',
      'chmod 755 ./opa',
      './opa version',
      'cd pipeline/opa',
      '../../opa test . -v'
    ],
    additionalArtifacts: [sourceArtifact],
    runOrder: OPAStage.nextSequentialRunOrder()
  });

  OPAStage.addActions(shellScriptAction);
}
```

#### CF Guard Stage
```typescript
import {CdkPipeline, ShellScriptAction} from "@aws-cdk/pipelines";
import {Artifact} from "@aws-cdk/aws-codepipeline";

export const addCFGuardStage = (pipeline:CdkPipeline, sourceArtifact:Artifact) => {

  const CFGuardStage = pipeline.addStage('CFGuardStage');
  const shellScriptAction = new ShellScriptAction({
    actionName: "CFGuardValidation",
    commands: [
      "cd pipeline",
      'ls -l',
      "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs > installrust.sh",
      'chmod 775 installrust.sh',
      './installrust.sh -y',
      '. $HOME/.cargo/env',
      'wget https://github.com/aws-cloudformation/cloudformation-guard/releases/download/1.0.0/cfn-guard-linux-1.0.0.tar.gz',
      'tar -xvf cfn-guard-linux-1.0.0.tar.gz',
      './cfn-guard-linux/cfn-guard --version',
      'cd cfnguard',
      'cargo test',
      'cd ..',
      './cfn-guard-linux/cfn-guard check -r rules/ecs_apploadbalancer.ruleset -t test/foo.template.json'
    ],
    additionalArtifacts: [sourceArtifact],
    runOrder: CFGuardStage.nextSequentialRunOrder()
  });

  CFGuardStage.addActions(shellScriptAction);
}
```

{{% notice note %}}
  The stage creation includes the installation of OPA/CFGuard and depended on libraries
{{% /notice %}}

#### Adding stage to a pipeline

```typescript
mport * as cdk from '@aws-cdk/core';
import * as codepipeline from '@aws-cdk/aws-codepipeline';
import * as codepipeline_actions from '@aws-cdk/aws-codepipeline-actions';
import { CdkPipeline, SimpleSynthAction } from "@aws-cdk/pipelines";
import {addCFGuardStage} from "./cdk-cfguard-stage";
import {addOPAStage} from "./cdk-opa-stage";

export class MyCustomPipelinesStack extends cdk.Stack {
    constructor(scope: cdk.Construct, id: string, props?: cdk.StackProps) {
        super(scope, id, props);

        const sourceArtifact = new codepipeline.Artifact();
        const cloudAssemblyArtifact = new codepipeline.Artifact();

        const pipeline = new CdkPipeline(this, 'myPipeline', {
            pipelineName: 'myCustomStagePipeline',
            cloudAssemblyArtifact,
          
            // Set a source for pipeline, using configuration fetched from a secret to access github
            sourceAction: new codepipeline_actions.GitHubSourceAction({
                actionName: 'GitHub',
                output: sourceArtifact,
                // @ts-ignore
                oauthToken: cdk.SecretValue.secretsManager('pipelineSecret', {
                    jsonField: 'githubToken'
                }),
                owner: cdk.SecretValue.secretsManager('pipelineSecret', {
                    jsonField: 'githubOwner'
                }).toString(),
                repo: cdk.SecretValue.secretsManager('pipelineSecret', {
                    jsonField: 'githubRepo'
                }).toString(),
                branch: cdk.SecretValue.secretsManager('pipelineSecret', {
                    jsonField: 'branch'
                }).toString()
            }),

            // Build and synthesize app to generate CF template --- you may use existing one and skip this step
            synthAction: new SimpleSynthAction({
                sourceArtifact,
                cloudAssemblyArtifact,
                subdirectory: 'pipeline',
                installCommands: [
                    'npm install -g aws-cdk',
                    'cdk --version',
                    'npm install',
                ],
                buildCommands: ['npm run build'],
                synthCommand: 'npx cdk synth'
            })
        });

        //Here we add the custom strage to the pipeline
        addCFGuardStage(pipeline, sourceArtifact)
        addOPAStage(pipeline, sourceArtifact)
    }
}

```
{{% notice note %}}
The last two lines is where we add our custom OPA/CF Guard stage.
{{% /notice %}}


{{% notice tip %}}
You can use the stage above regardless to the pipeline example and simply use the [pipeline.addStage](https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_aws-codepipeline.Pipeline.html)
{{% /notice %}}

Let's execute the pipeline:
```
cdk synth
```
Now deploy
```
cdk deploy
```
The new pipeline will be created and ready to execute - you may see the new custom stage as part of the pipeline. if a rule will fail the pipeline will break.
