---
title: "Policy as Code pipeline"
weight: 61
---

## Overview
This section will explore using policy as code tools to provide guardrails for IaC deployments. Policy as Code tools serve as gatekeepers to resource deployments that do not comply
with the policies an organization has established. There are many CI/CD tools that can be used to implement this workflow but for this workshop AWS CodePipeline will be used. The
concepts used here would be applicable to any CI/CD tool.

This pipeline will be used to deploy a compliant S3 bucket. Here is a typical policy that needs to be enforced:

>***AWS S3 buckets need to be deployed in a secure manner. We require encryption using strong and industry standard cryptography methods for data at rest and transit. - [NIST-800-53-SC-13](https://csrc.nist.gov/Projects/risk-management/sp800-53-controls/release-search#!/control?version=5.1&number=SC-13)
>There should be no public access and access should be restricted to the account that writes the data. Least privileged access should be enforced. - [NIST 800-53-8(2)](https://csrc.nist.gov/Projects/risk-management/sp800-53-controls/release-search#!/control?version=5.1&number=SA-8)***

An IaC developer will need to develop a set of rules to enforce the policy stated above. Here is a list of rules that will be used to enforce the policy above:
* ***Use S3 Block Public Access***
* ***Configure server-side encryption of S3 buckets***
* ***Use AWS managed keys for encryption of data in S3 bucket***
* ***Use a bucket policy to enforce HTTPS(TLS) connections only when reading or writing data***
* ***Use a bucket policy to enforce server-side encryption during object puts/writes to bucket***
* ***AWS KMS key used with the S3 bucket needs to have automatic rotation***
* ***AWS KMS key policy should not allow cross-account key access***

Fortunately the rules have already been written. The objective of this section of the workshop is to write the IaC code to pass the rules above. AWS Cloud Development Kit (CDK) will be used to deploy the S3 resource. Review of the AWS Cloudformation(CFN) templates that are generated by CDK will be used to see how they are violating the rules that are written. The CDK application will than be updated to pass the rules above. The outcome will be the successfully deployment of a compliant S3 bucket.

::alert[The AWS CodePipeline in this workshop is for educational and demo purposes only.]

## Getting Started
There are two options for running this part of the workshop:
* Running this workshop in your own AWS - [Using your own AWS account](/deployment/pipeline-integration#using-your-own-aws-account)
* Running a AWS Hosted Event - [AWS Hosted Event](/deployment/pipeline-integration#aws-hosted-event)

### Using your own AWS account
The environment needs to have the following tools installed.
1. [An AWS account](https://aws.amazon.com/getting-started/)
1. Setup AWS Cloud9 - [Create an environment](https://docs.aws.amazon.com/cloud9/latest/user-guide/tutorial-create-environment.html)
   * **Environment type** - Create a new no-ingress EC2 instance for environment (access via Systems Manager)
   * **Instance type** - Amazon Linux 2
1. Create a IAM role named **PolicyAsCodeRole** for configuring Cloud0 instance and deploying AWS CodePipeline [here](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies_job-functions_create-policies.html) and select EC2 as the trusted entity. Choose the following AWS Managed Policies
   * AdministratorAccess
   * AWSCodeCommitPowerUser
   * AWSCodePipeline_ReadOnlyAccess
   * AWSCloud9SSMInstanceProfile
1. Attach the IAM role to the EC2 instance that has the prefix aws-cloud9-<**Name of the environment you've given it**>
1. Open your environment to Cloud9 specified [here](https://docs.aws.amazon.com/cloud9/latest/user-guide/open-environment.html)
1. Disable AWS managed temporary credentials in Cloud9 [settings](https://docs.aws.amazon.com/cloud9/latest/user-guide/security-iam.html#auth-and-access-control-temporary-managed-credentials).
1. Run the aws cli subcommand configure and leave everything blank but your region:
    ```
    aws configure
    AWS Access Key ID [None]: 
    AWS Secret Access Key [None]: 
    Default region name [None]: us-east-2 or whatever your actual region is.
    Default output format [None]:
    ```
1. Increase the volume size of your Cloud9 instance specified [here](https://docs.aws.amazon.com/cloud9/latest/user-guide/move-environment.html#move-environment-resize).
1. checkov - [Installing Checkov](/checkov/install-checkov)
1. cfn-guard - [Installing cfn-guard](https://github.com/aws-cloudformation/cloudformation-guard#installation)
1. Clone the policy-as-code repository from github in the environment directory:
    :::code{showCopyAction=true showLineNumbers=false}
    cd environment;git clone https://github.com/aws-samples/policy-as-code.git
    :::
1. Install the AWS CodePipeline as follows:
:::code{showCopyAction=true showLineNumbers=false}
cd ~/environment/policy-as-code/cdk/cicd
pip install -r requirements.txt
cdk bootstrap
cdk deploy --all
:::
13. Answer 'y' to all prompts.
1. Remove AdministratorAccess from the IAM role **PolicyAsCodeRole**.

### AWS Hosted Event
* Obtain the **Event Hash** for [AWS Event Engine](https://dashboard.eventengine.run/login)
* An AWS CodePipeline should be provisioned for you skip to the next section [AWS CodePipeline Run](/deployment/pipeline-integration#aws-codepipeline-run)

## AWS CodePipeline Run
The S3 application is ready to be deployed. In order for it to be deployed successfully it must comply with the rules created as specified above.
To kickoff the deployment use git push to AWS CodeCommit which is the source for the pipeline. During this workshop the CDK/CFN template will be
changed to comply with the rules specified in the AWS CodePipeline. Do the following:

1. Clone the workshop repo (If this is not already done.):
:::code{showCopyAction=true showLineNumbers=false}
cd ~/environment
git clone https://github.com/aws-samples/policy-as-code.git
:::
2. Remove the reference to the upstream code repo by issuing the command:
:::code{showCopyAction=true showLineNumbers=false}
git remote remove origin
:::
3. Get the repository clone URL by running the the following commands and adding it as our remote origin:
:::code{showCopyAction=true showLineNumbers=false}
export repo=$(aws codecommit list-repositories --output text | awk '{print $3}' | grep policy-as-code)
export codecommiturl=$(aws codecommit get-repository --repository-name ${repo} --query 'repositoryMetadata.cloneUrlHttp' --output text)
git remote add origin ${codecommiturl}
:::
4. Make sure that you have the git-remote-codecommit python package installed. This helps with authenticating with CodeCommit.
:::code{showCopyAction=true}
pip install git-remote-codecommit
:::
5. Push the repo
:::code{showCopyAction=true showLineNumbers=false}
git push --set-upstream origin main
:::
6. View the CodePipeline in your account. Instructions to do that is [here](https://docs.aws.amazon.com/codepipeline/latest/userguide/pipelines-view-console.html#pipelines-list-console.). Give it about a minute to restart. Initially the Pipeline will have failed because when deployed for the first time there was nothing in the CodeCommit repo.
7. Your CodePipeline will fail on the stage **ScanDeploy** stage. Click on the **Details** on the Scan - AWS CodeBuild.
![ScanDeployFailed](/static/ScanDeployFailed.png)
8. You'll get a pop box that looks like below. Click on **Link to execution details**:
![LinkExecutionDetail](/static/LinkExecutionDetails.png)
9. This should bring you to the CodeBuild project. The two failures look like this:
```
Check: CKV_AWS_53: "Ensure S3 bucket has block public ACLS enabled"
    FAILED for resource: AWS::S3::Bucket.Bucket83908E77
    File: /policy-as-code.template.json:3-50
    Guide: https://docs.bridgecrew.io/docs/bc_aws_s3_19

        3  |     "Bucket83908E77": {
        4  |       "Type": "AWS::S3::Bucket",
        5  |       "Properties": {
...
        29 |         "PublicAccessBlockConfiguration": {
        30 |           "BlockPublicAcls": false,
        31 |           "BlockPublicPolicy": true,
        32 |           "IgnorePublicAcls": true,
        33 |           "RestrictPublicBuckets": true
```
```
Check: CKV_AWS_19: "Ensure the S3 bucket has server-side-encryption enabled"
    FAILED for resource: AWS::S3::Bucket.Bucket83908E77
    File: /policy-as-code.template.json:3-50
    Guide: https://docs.bridgecrew.io/docs/s3_14-data-encrypted-at-rest

        3  |     "Bucket83908E77": {
        4  |       "Type": "AWS::S3::Bucket",
        5  |       "Properties": {
```
10. The S3 deployment is running into issues with checkov. The next section will look into fixing the issues and validating that S3 compliance with the checkov rules.

## Fixing CDK/CFN Template for Checkov rules violations
1. The two issues flagged by [checkov](https://github.com/bridgecrewio/checkov) are as follows:
    * CKV_AWS_53: "Ensure S3 bucket has block public ACLS enabled"
    * CKV_AWS_19: "Ensure the S3 bucket has server-side-encryption enabled"
1. To validate the same issue locally. Run the following commands:
   :::code{showCopyAction=true showLineNumbers=false}
   # Commands to setup CDK app locally, generate cfn template, and validate with checkov
   cd ~/environment/policy-as-code/cdk/app/
   pip install -r requirements.txt
   cdk synth
   checkov --directory cdk.out --config-file ./rules/checkov/checkov-config.yml
   :::
1. Verify that the same issues that checkov flagged in codebuild exists in the local environment.
1. CDK generated the CFN template that is in violation. Examine the CFN template by opening the file **cdk.out/policy-as-code.template.json** in the Cloud9 IDE:
    ![PolicyAsCodeTmpl](/static/PolicyAsCodeTmpl.png)
    Note the PublicAccessBlockConfiguration that checkov flagged:
    ```
    ...
    "PublicAccessBlockConfiguration": {
      "BlockPublicAcls": false,
      "BlockPublicPolicy": true,
      "IgnorePublicAcls": true,
      "RestrictPublicBuckets": true
    },
    ...
    ```
    The **BlockPublicAcls** has been set to **false** this needs to be **true**. To fix this go to the CDK source file that generated this template.
1. Open the file **s3_deployment.py** in the Cloud9's editor/IDE.
    ![S3DeploymentTree](/static/S3DeploymentTree.png)
    Find the section in the file that looks like this:
    ```
    ...
    block_public_access=aws_cdk.aws_s3.BlockPublicAccess(
        # Uncomment block_public_acls=True and remove block_public_acls=False
        # block_public_acls=True,
        block_public_acls=False,
        restrict_public_buckets=True,
        block_public_policy=True,
        ignore_public_acls=True
    )
    ...
    ```
    Here block_public_acls=False has been explicitly set. Remove that line and Uncomment the line of
    code above it. It will look like this:
    ```
    ...
    block_public_access=aws_cdk.aws_s3.BlockPublicAccess(
        # Uncomment block_public_acls=True and remove block_public_acls=False
        block_public_acls=True,
        restrict_public_buckets=True,
        block_public_policy=True,
        ignore_public_acls=True
    )
    ...
    ```
    Save the file in Cloud9 editor by clicking on **File**
    ![S3DeploymentFileSave.png](/static/S3DeploymentFileSave.png)
1. Run the following commands to see if the code change will fix this:
   :::code{showCopyAction=true showLineNumbers=false}
   cdk synth; checkov --directory cdk.out --config-file ./rules/checkov/checkov-config.yml
   :::
1. At this point there should only be one issue with checkov:
   ```
   ...
   Check: CKV_AWS_19: "Ensure the S3 bucket has server-side-encryption enabled"
        FAILED for resource: AWS::S3::Bucket.Bucket83908E77
        File: /policy-as-code.template.json:3-50
        Guide: https://docs.bridgecrew.io/docs/s3_14-data-encrypted-at-rest

                3  |     "Bucket83908E77": {
                4  |       "Type": "AWS::S3::Bucket",
                5  |       "Properties": {
   ...
   ```
1. To enable server-side-encryption encryption of the S3 bucket, open the file **cdk.out/policy-as-code.template.json** in Cloud9. Remember that since we are using a CDK app to create this CloudFormation template, you should edit the CDK App instead of the Rendered CloudFormation. 
    ```
    ...
    "Bucket83908E77": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "LifecycleConfiguration": {...},
        "PublicAccessBlockConfiguration": {...},
        "Tags": [...],
        "VersioningConfiguration": {...}
      },
      "UpdateReplacePolicy": "Delete",
      "DeletionPolicy": "Delete",
      "Metadata": {
        "aws:cdk:path": "policy-as-code/Bucket/Resource"
      }
    }
    ...
    ```
    The property **BucketEncryption** is not set. Modify the CDK code to generate the CFN template that will set this property. Open the file **s3_deployment.py** and find the code that matches:
    ```
        ...
        # Uncommment to make checkov pass
        # encryption=aws_s3.BucketEncryption.S3_MANAGED,
        ...
    ```
    Uncomment **encryption=aws_s3.BucketEncryption.S3_MANAGED,** it should look like this:
    ```
        ...
        # Uncommment to make checkov pass
        encryption=aws_s3.BucketEncryption.S3_MANAGED,
        ...
    ```
    Save the file in Cloud9 and run:
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/cdk/app/; cdk synth
    :::
    Open the file **cdk.out/policy-as-code.template.json** and inspect the CFN template:
    ```
    ...
    "Bucket83908E77": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "LifecycleConfiguration": {...},
        "PublicAccessBlockConfiguration": {...},
        "Tags": [...],
        "VersioningConfiguration": {...}
      },
      "UpdateReplacePolicy": "Delete",
      "DeletionPolicy": "Delete",
      "Metadata": {
        "aws:cdk:path": "policy-as-code/Bucket/Resource"
      }
    }
    ...
    ```
    The CFN Template has the **BucketEncryption** property set.
1. Run checkov to validate the template:
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/cdk/app/;checkov --directory cdk.out --config-file ./rules/checkov/checkov-config.yml
    :::
    The output should look like this, with all 8 tests passing:
    ```
    cloudformation scan results:

    Passed checks: 8, Failed checks: 0, Skipped checks: 0

    Check: CKV_AWS_53: "Ensure S3 bucket has block public ACLS enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/bc_aws_s3_19

    Check: CKV_AWS_54: "Ensure S3 bucket has block public policy enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/bc_aws_s3_20

    Check: CKV_AWS_19: "Ensure the S3 bucket has server-side-encryption enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/s3_14-data-encrypted-at-rest

    Check: CKV_AWS_55: "Ensure S3 bucket has ignore public ACLs enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/bc_aws_s3_21

    Check: CKV_AWS_20: "Ensure the S3 bucket does not allow READ permissions to everyone"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/s3_1-acl-read-permissions-everyone

    Check: CKV_AWS_57: "Ensure the S3 bucket does not allow WRITE permissions to everyone"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/s3_2-acl-write-permissions-everyone

    Check: CKV_AWS_56: "Ensure S3 bucket has 'restrict_public_bucket' enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/bc_aws_s3_22

    Check: CKV_AWS_21: "Ensure the S3 bucket has versioning enabled"
            PASSED for resource: AWS::S3::Bucket.Bucket83908E77
            File: /policy-as-code.template.json:3-59
            Guide: https://docs.bridgecrew.io/docs/s3_16-enable-versioning
    ``` 
1. Commit the changes to the repo and push to the source CodeCommit repo to kick of the pipeline.
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/;git commit -a -m "fix checkov violations in s3_deployment.py";git push
    :::
1. View the CodePipeline in your account. Instructions to do that is [here](https://docs.aws.amazon.com/codepipeline/latest/userguide/pipelines-view-console.html#pipelines-list-console.). Give it about a minute to restart. Verify that the checkov rules have passed but that the cfn-guard rules are now failing. Your CodePipeline will fail on the stage **ScanDeploy** stage. Click on the **Details** on the Scan - AWS CodeBuild.
    ![ScanDeployFailed](/static/ScanDeployFailed.png)
1. You'll get a pop box that looks like below. Click on **Link to execution details**:
    ![LinkExecutionDetail](/static/LinkExecutionDetails.png)
1. The S3 deployment is running into issues with cfn-guard. The next section will look into fixing the issues and validating that S3 compliance with the cfn-guard rules.

## Fixing CDK/CFN Template for cfn-guard rules violations
1. As from before replicate cfn-guard run in the local environment. Run the following commands to do that:
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/cdk/app;cdk synth;cfn-guard validate -r rules/cfn-guard -d cdk.out/policy-as-code.template.json
    :::

    Below is what cfn-guard should output, this will look similiar to what is in the CodeBuild logs:
    ```
    cdk.out/policy-as-code.template.json Status = SKIP
    SKIP rules
    kms/kms.guard/deny_kms_key_being_used_outside_account    SKIP
    kms/kms.guard/deny_kms_key_without_key_rotation          SKIP
    ---
    cdk.out/policy-as-code.template.json Status = FAIL
    SKIP rules
    s3/bucket_policies.guard/deny_s3_buckets_over_insecure_transport            SKIP
    s3/bucket_policies.guard/check_s3_buckets_have_deny_for_unencrypted_puts    SKIP
    FAILED rules
    s3/bucket_policies.guard/check_all_s3_buckets_have_policy                   FAIL
    ---
    `- File(, Status=FAIL)[Context=File(rules=3)]
    |- Rule(check_all_s3_buckets_have_policy, Status=FAIL)[Context=check_all_s3_buckets_have_policy]
    |  `- Check was not compliant as variable in context [ %s3_policy_bucket_refs not EMPTY  ] was not empty. Message [Bucket policies must be defined within the same stack template]
    cdk.out/policy-as-code.template.json Status = PASS
    PASS rules
    s3/bucket_public_exposure.guard/deny_s3_access_control           PASS
    s3/bucket_public_exposure.guard/deny_s3_notification_settings    PASS
    s3/bucket_public_exposure.guard/deny_s3_cors_settings            PASS
    s3/bucket_public_exposure.guard/deny_s3_website_configuration    PASS
    s3/bucket_public_exposure.guard/deny_s3_public_access            PASS
    ---
    cdk.out/policy-as-code.template.json Status = FAIL
    SKIP rules
    s3/bucket_server_side_encryption.guard/check_s3_sse_kms_local_stack_only    SKIP
    PASS rules
    s3/bucket_server_side_encryption.guard/check_s3_sse_is_enabled              PASS
    FAILED rules
    s3/bucket_server_side_encryption.guard/check_s3_sse_kms_only                FAIL
    ---
    `- File(, Status=FAIL)[Context=File(rules=3)]
    |- Rule(check_s3_sse_kms_only, Status=FAIL)[Context=check_s3_sse_kms_only]
    |  `- Rule(check_s3_sse_kms, Status=FAIL)[Context=check_s3_sse_kms]
    |     `- Check was not compliant as property value [Path=/Resources/Bucket83908E77/Properties/BucketEncryption/ServerSideEncryptionConfiguration/0/ServerSideEncryptionByDefault/SSEAlgorithm, Value="AES256"] not equal to value [Path=, Value="aws:kms"]. Message = [Algorithm must be set of 'aws:kms']
    |     `- Check was not compliant as property [KMSMasterKeyID] is missing. Value traversed to [Path=/Resources/Bucket83908E77/Properties/BucketEncryption/ServerSideEncryptionConfiguration/0/ServerSideEncryptionByDefault, Value={"SSEAlgorithm":"AES256"}]. Message = [KMS Key must be set]
    ```
1. The first issue that fails is:
    ```
    s3/bucket_policies.guard/check_all_s3_buckets_have_policy                   FAIL
    ```
    Examine the file **./policy-as-code/cdk/app/cdk.out/policy-as-code.template.json**. There is no resource AWS::S3::BucketPolicy defined.

    As from before modifying the CDK source code will generate the CFN template. Setting to **true**
    the [**enforceSSL**](https://docs.aws.amazon.com/cdk/api/latest/docs/@aws-cdk_aws-s3.Bucket.html#enforcessl) in **Construct Properties** will force the creation of a S3 bucket policy that
    will require TLS/SSL. As a side effect this will also comply with the rule:
    ```
    s3/bucket_policies.guard/deny_s3_buckets_over_insecure_transport            SKIP
    ```
    Which is currently being skipped because there is no bucket policy to check.
    Open the file **./policy-as-code/cdk/app/s3_deployment.py** and find the commented out section:
    ```
    ...
        # Uncomment to enforce_ssl
        # enforce_ssl=True,
    ...
    ```
    Uncomment the line **enforce_ssl=True,** It should look like this after modified:
    ```
    ...
        # Uncomment to enforce_ssl
        enforce_ssl=True,    
    ...
    ```
    Save the file using Cloud9 menu File->Save
1. Validate the code by running:
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/cdk/app;cdk synth;cdk synth;cfn-guard validate -r rules/cfn-guard -d cdk.out/policy-as-code.template.json
    :::
    Although the s3 bucket policies:
    ```
    PASS rules
    s3/bucket_policies.guard/check_all_s3_buckets_have_policy                   PASS
    s3/bucket_policies.guard/deny_s3_buckets_over_insecure_transport            PASS
    ```
    Are passing. The s3 bucket policy:
    ```
    FAILED rules
    s3/bucket_policies.guard/check_s3_buckets_have_deny_for_unencrypted_puts    FAIL
    ```
    The rule that is failing is **check_s3_buckets_have_deny_for_unencrypted_puts** but what seems to be
    causing it to fail is the rule that it calls **check_unencrypted_deny_statement**
    ```
    ...
   - Rule(check_s3_buckets_have_deny_for_unencrypted_puts, Status=FAIL)[Context=check_s3_buckets_have_deny_for_unencrypted_puts]
      `- Disjunction(Status = FAIL)[Context=cfn_guard::rules::exprs::GuardClause#disjunction]
         |- Rule(check_unencrypted_deny_statement, Status=FAIL)[Context=check_unencrypted_deny_statement]
         |  `- Disjunction(Status = FAIL)[Context=cfn_guard::rules::exprs::RuleClause#disjunction]
         |     |- Rule(check_sse, Status=FAIL)[Context=check_sse]
         |     |  `- Disjunction(Status = FAIL)[Context=cfn_guard::rules::exprs::RuleClause#disjunction]
         |     |     `- Check was not compliant as property [StringNotEqualsIfExists.%key] to compare from is missing. Value traversed to [Path=/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition, Value={"Bool":{"aws:SecureTransport":"false"}}].
         |     |     `- Rule(check_null_string_not_eq_combo, Status=FAIL)[Context=check_null_string_not_eq_combo]
         |     |        `- Check was not compliant as property [StringNotEquals.%key] to compare from is missing. Value traversed to [Path=/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition, Value={"Bool":{"aws:SecureTransport":"false"}}]. Message = [ DENY statement does not contain any StringNotEquals Condition to match value ]
         |     |        `- Check was not compliant as property [/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition/Bool] was not empty. Message = [ DENY statement must contain only one StringNotEquals key ]
         |     |        `- Check was not compliant as property [Null.%key] to compare from is missing. Value traversed to [Path=/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition, Value={"Bool":{"aws:SecureTransport":"false"}}]. Message = [ DENY statement does not contain any Null checks == true ]
         |     |        `- Check was not compliant as property [/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition/Bool] was not empty. Message = [ DENY statement mut contain only one Null key ]
         |     |- Rule(check_sse, Status=FAIL)[Context=check_sse]
         |     |  `- Disjunction(Status = FAIL)[Context=cfn_guard::rules::exprs::RuleClause#disjunction]
         |     |     `- Check was not compliant as property [StringNotEqualsIfExists.%key] to compare from is missing. Value traversed to [Path=/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition, Value={"Bool":{"aws:SecureTransport":"false"}}].
         |     |     `- Rule(check_null_string_not_eq_combo, Status=FAIL)[Context=check_null_string_not_eq_combo]
         |     |        `- Check was not compliant as property [StringNotEquals.%key] to compare from is missing. Value traversed to [Path=/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition, Value={"Bool":{"aws:SecureTransport":"false"}}]. Message = [ DENY statement does not contain any StringNotEquals Condition to match value ]
         |     |        `- Check was not compliant as property [/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition/Bool] was not empty. Message = [ DENY statement must contain only one StringNotEquals key ]
         |     |        `- Check was not compliant as property [Null.%key] to compare from is missing. Value traversed to [Path=/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition, Value={"Bool":{"aws:SecureTransport":"false"}}]. Message = [ DENY statement does not contain any Null checks == true ]
         |     |        `- Check was not compliant as property [/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition/Bool] was not empty. Message = [ DENY statement mut contain only one Null key ]
         |     `- Rule(check_kms_id, Status=FAIL)[Context=check_kms_id]
         |        `- Disjunction(Status = FAIL)[Context=cfn_guard::rules::exprs::RuleClause#disjunction]
         |           `- Check was not compliant as property [StringNotEqualsIfExists.%key] is missing. Value traversed to [Path=/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition, Value={"Bool":{"aws:SecureTransport":"false"}}].
         |           `- Rule(check_null_string_not_eq_combo, Status=FAIL)[Context=check_null_string_not_eq_combo]
         |              `- Check was not compliant as property [StringNotEquals.%key] to compare from is missing. Value traversed to [Path=/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition, Value={"Bool":{"aws:SecureTransport":"false"}}]. Message = [ DENY statement does not contain any StringNotEquals Condition to match value ]
         |              `- Check was not compliant as property [/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition/Bool] was not empty. Message = [ DENY statement must contain only one StringNotEquals key ]
         |              `- Check was not compliant as property [Null.%key] to compare from is missing. Value traversed to [Path=/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition, Value={"Bool":{"aws:SecureTransport":"false"}}]. Message = [ DENY statement does not contain any Null checks == true ]
         |              `- Check was not compliant as property [/Resources/BucketPolicyE9A3008A/Properties/PolicyDocument/Statement/0/Condition/Bool] was not empty. Message = [ DENY statement mut contain only one Null key ]
    ...
    ```
    Inspect the rules file by opening **./policy-as-code/cdk/app/rules/cfn-guard/s3/bucket_policies.guard**. Find the rule **check_unencrypted_deny_statement** and examine the clauses:
    ```
    rule check_unencrypted_deny_statement(statements) {
    #
    # Select all DENY statements in the policy and check for Action == 's3:PutObject'
    # and Principal == '*'
    #
    let deny_statements = %statements[ Effect == 'Deny' ]

    %deny_statements not empty
        << There are no DENY statements in the policy document >>

    # Disabled this rule, don't really understand why it is a failure to just deny s3:PutObject
    # CDK will generate a bucket policy that has s3:*
    #some %deny_statements {
    #    Action == 's3:PutObject'
    #        << DENY MUST contain only s3:PutObject action and nothing else >>

    some %deny_statements {
        Principal == '*' or
        Principal.AWS == '*'
            << Principal MUST be '*' or {AWS: '*'} for DENY, To keep policy simple do not include others >>
    }


    check_sse(%deny_statements, 's3:x-amz-server-side-encryption', 'AES256', %name)     or
    check_sse(%deny_statements, 's3:x-amz-server-side-encryption', 'aws:kms', %name)    or
    check_kms_id(%deny_statements, 's3:x-amz-server-side-encryption-aws-kms-key-id', %name)

    }
    ```
    The statement check_sse and check_kms_id are failing.
    To better understand this checkout this AWS doc [Protecting data using server-side encryption with Amazon S3-managed encryption keys (SSE-S3)](https://docs.aws.amazon.com/AmazonS3/latest/userguide/UsingServerSideEncryption.html). It specifies a bucket policy that needs to be added to the current
    bucket policy. Examine the CFN template that was generated, open file **./policy-as-code/cdk/app/cdk.out/policy-as-code.template.json**. It has the following bucket policy:
    ```
    "BucketPolicyE9A3008A": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
          "Ref": "Bucket83908E77"
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:*",
              "Condition": {
                "Bool": {
                  "aws:SecureTransport": "false"
                }
              },
              "Effect": "Deny",
              "Principal": {
                "AWS": "*"
              },
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "Bucket83908E77",
                    "Arn"
                  ]
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "Bucket83908E77",
                          "Arn"
                        ]
                      },
                      "/*"
                    ]
                  ]
                }
              ]
            }
          ],
          "Version": "2012-10-17"
        }
      },
      "Metadata": {
        "aws:cdk:path": "policy-as-code/Bucket/Policy/Resource"
      }
    },
    ```

    Focusing on the messages:
    ```
    Message = [ DENY statementmust contain only one StringNotEquals key ]
    Message = [ DENY statement does notcontain any Null checks == true ]
    Message = [ DENY statementmut contain only one Null key ]
    ```
    The cfn-guard messages indicate the current CFN template is missing deny statements in the S3 bucket policy. Address this by adding the deny statements to the S3 bucket policy. 
1.  Add the deny statements by updating the CDK source code, open the file **./policy-as-code/cdk/app/s3_deployment.py**. Find the section of the file with the comment:
    ```
        ...
        # Insert new policy statement that denies s3:PutObject if encryption header is not set
        # End of new policy statement
        ...
    ```
    Insert the following block of code:
    :::code{showCopyAction=true}
        unencrypted_put_conditions = [
            {'StringNotEquals': { 's3:x-amz-server-side-encryption': 'AES256'}},
            {'StringNotEquals': { 's3:x-amz-server-side-encryption': 'aws:kms'}},
            {'Null': {'s3:x-amz-server-side-encryption': True}}
        ]
        
        for condition in unencrypted_put_conditions:
            bucket.add_to_resource_policy(
                aws_iam.PolicyStatement(
                    actions=[
                        "s3:PutObject"
                    ],
                    effect=aws_iam.Effect.DENY,
                    principals=[
                        aws_iam.AnyPrincipal()
                    ],
                    resources=[
                        bucket.bucket_arn + "/*"
                    ],
                    conditions=condition
                )
            )
    :::
    When inserted it should look like this:
    ```
        ...
        # Insert new policy statement that denies s3:PutObject if encryption header is not set
        unencrypted_put_conditions = [
            {'StringNotEquals': { 's3:x-amz-server-side-encryption': 'AES256'}},
            {'StringNotEquals': { 's3:x-amz-server-side-encryption': 'aws:kms'}},
            {'Null': {'s3:x-amz-server-side-encryption': True}}
        ]
        
        for condition in unencrypted_put_conditions:
            bucket.add_to_resource_policy(
                aws_iam.PolicyStatement(
                    actions=[
                        "s3:PutObject"
                    ],
                    effect=aws_iam.Effect.DENY,
                    principals=[
                        aws_iam.AnyPrincipal()
                    ],
                    resources=[
                        bucket.bucket_arn + "/*"
                    ],
                    conditions=condition
                )
            )
        # End of new policy statement
        ...
    ```
    Save this file in Cloud9 with the menu File->Save.
1. Validate the code by running:
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/cdk/app;cdk synth;cdk synth;cfn-guard validate -r rules/cfn-guard -d cdk.out/policy-as-code.template.json
    :::
    The output after cfn-guard runs should look like this:
    ```
    cdk.out/policy-as-code.template.json Status = SKIP
    SKIP rules
    kms/kms.guard/deny_kms_key_being_used_outside_account    SKIP
    kms/kms.guard/deny_kms_key_without_key_rotation          SKIP
    ---
    cdk.out/policy-as-code.template.json Status = PASS
    PASS rules
    s3/bucket_policies.guard/check_all_s3_buckets_have_policy                   PASS
    s3/bucket_policies.guard/deny_s3_buckets_over_insecure_transport            PASS
    s3/bucket_policies.guard/check_s3_buckets_have_deny_for_unencrypted_puts    PASS
    ---
    cdk.out/policy-as-code.template.json Status = PASS
    PASS rules
    s3/bucket_public_exposure.guard/deny_s3_access_control           PASS
    s3/bucket_public_exposure.guard/deny_s3_notification_settings    PASS
    s3/bucket_public_exposure.guard/deny_s3_cors_settings            PASS
    s3/bucket_public_exposure.guard/deny_s3_website_configuration    PASS
    s3/bucket_public_exposure.guard/deny_s3_public_access            PASS
    ---
    cdk.out/policy-as-code.template.json Status = FAIL
    SKIP rules
    s3/bucket_server_side_encryption.guard/check_s3_sse_kms_local_stack_only    SKIP
    PASS rules
    s3/bucket_server_side_encryption.guard/check_s3_sse_is_enabled              PASS
    FAILED rules
    s3/bucket_server_side_encryption.guard/check_s3_sse_kms_only                FAIL
    ---
    `- File(, Status=FAIL)[Context=File(rules=3)]
       |- Rule(check_s3_sse_kms_only, Status=FAIL)[Context=check_s3_sse_kms_only]
       |  `- Rule(check_s3_sse_kms, Status=FAIL)[Context=check_s3_sse_kms]
       |     `- Check was not compliant as property value [Path=/Resources/Bucket83908E77/Properties/   BucketEncryption/ServerSideEncryptionConfiguration/0/ServerSideEncryptionByDefault/SSEAlgorithm,   Value="AES256"] not equal to value [Path=, Value="aws:kms"]. Message = [Algorithm must be set of  'aws:kms']
       |     `- Check was not compliant as property [KMSMasterKeyID] is missing. Value traversed to [Path=/ Resources/Bucket83908E77/Properties/BucketEncryption/ServerSideEncryptionConfiguration/0/    ServerSideEncryptionByDefault, Value={"SSEAlgorithm":"AES256"}]. Message = [KMS Key must be set]
    ```
    The rule **s3/bucket_server_side_encryption.guard/check_s3_sse_kms_only** is not satisfied because it expects the S3 property **BucketEncryption** property to use AWS KMS-managed keys(SSE-KMS). Examine the CFN template to see what is currently configured for **BucketEncryption**, open the file **./policy-as-code/cdk/app/cdk.out/policy-as-code.template.json** the following is what is currently configured:
    ```
        ...
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        ...
    ```
    In order to comply with this rule the **BucketEncryption** should look something like:
    ```
        ...
        "BucketEncryption": {
            "ServerSideEncryptionConfiguration": [
                {
                    "ServerSideEncryptionByDefault": {
                        "SSEAlgorithm": "aws:kms",
                        "KMSMasterKeyID": "KMS-KEY-ARN"
                    }
                }
            ]
        }
        ...
    ```
    This will require creating a KMS key as well is configuring the S3 bucket to use the KMS key.
1. Creating the KMS key and configuring the S3 bucket to use the KMS key will require modification to the CDK source code. Open the file **./policy-as-code/cdk/app/s3_deployment.py** and find the following section:
    ```
        ...
        # Insert KMS key here

        # End of KMS key here
        ...
    ```
    Copy the following code snippet. It creates the KMS key for the S3 bucket:
    :::code{showCopyAction=true showLineNumbers=false}
        kms_key = aws_kms.Key(self, 'KmsKey',
            enable_key_rotation=True
        )
        
        kms_key.add_to_resource_policy(
            aws_iam.PolicyStatement(
                actions=[
                    '*',
                    'kms:*'
                ],
                effect=aws_iam.Effect.DENY,
                principals=[
                        aws_iam.AnyPrincipal()
                ],
                resources=[
                        "*"
                ],
                conditions={'StringNotEquals': {'kms:CallerAccount': self.account}}
            )
        )
    :::
    The result should look like this:
    ```
        ...
        # Insert KMS key here
        kms_key = aws_kms.Key(self, 'KmsKey',
            enable_key_rotation=True
        )
        
        kms_key.add_to_resource_policy(
            aws_iam.PolicyStatement(
                actions=[
                    '*',
                    'kms:*'
                ],
                effect=aws_iam.Effect.DENY,
                principals=[
                        aws_iam.AnyPrincipal()
                ],
                resources=[
                        "*"
                ],
                conditions={'StringNotEquals': {'kms:CallerAccount': self.account}}
            )
        )
        # End of KMS key here
        ...
    ```
    Uncomment the line **buket_key_enabled=True,**:
    ```
        ...
        # Uncomment bucket_key_enabled=True, once the KMS key is defined
        # bucket_key_enabled=True,
        ...
    ```
    This should look like this after completed:
    ```
        ...
        # Uncomment bucket_key_enabled=True, once the KMS key is defined
        bucket_key_enabled=True,
        ...
    ```
    Finally remove the line **encryption=aws_s3.BucketEncryption.S3_MANAGED,** and uncomment **encryption=aws_s3.BucketEncryption.KMS,**:
    ```
        ...
        # Once you define the KMS key uncomment encryption=aws_s3.BucketEncryption.KMS attribute
        # Remove the encryption=aws_s3.BucketEncryption.S3_MANAGED completely
        # encryption=aws_s3.BucketEncryption.KMS,
            
        # Uncommment to make checkov pass
        encryption=aws_s3.BucketEncryption.S3_MANAGED,
        ...
    ```
    When finished it should look like this:
    ```
        ...
        # Once you define the KMS key uncomment encryption=aws_s3.BucketEncryption.KMS attribute
        # Remove the encryption=aws_s3.BucketEncryption.S3_MANAGED completely
        encryption=aws_s3.BucketEncryption.KMS,
            
        # Uncommment to make checkov pass
        ...
    ```
    These changes to S3 bucket with in CDK is needed to configure the S3 with the KMS key that will be created. Save the file in Cloud9 under menu File->Save.
1. Validate the code by running:
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/cdk/app;cdk synth;cdk synth;cfn-guard validate -r rules/cfn-guard -d cdk.out/policy-as-code.template.json
    :::
    The output after cfn-guard runs should look like this:
    ```
    cdk.out/policy-as-code.template.json Status = PASS
    PASS rules
    kms/kms.guard/deny_kms_key_being_used_outside_account    PASS
    kms/kms.guard/deny_kms_key_without_key_rotation          PASS
    ---
    cdk.out/policy-as-code.template.json Status = PASS
    PASS rules
    s3/bucket_policies.guard/check_all_s3_buckets_have_policy                   PASS
    s3/bucket_policies.guard/deny_s3_buckets_over_insecure_transport            PASS
    s3/bucket_policies.guard/check_s3_buckets_have_deny_for_unencrypted_puts    PASS
    ---
    cdk.out/policy-as-code.template.json Status = PASS
    PASS rules
    s3/bucket_public_exposure.guard/deny_s3_access_control           PASS
    s3/bucket_public_exposure.guard/deny_s3_notification_settings    PASS
    s3/bucket_public_exposure.guard/deny_s3_cors_settings            PASS
    s3/bucket_public_exposure.guard/deny_s3_website_configuration    PASS
    s3/bucket_public_exposure.guard/deny_s3_public_access            PASS
    ---
    cdk.out/policy-as-code.template.json Status = PASS
    PASS rules
    s3/bucket_server_side_encryption.guard/check_s3_sse_is_enabled              PASS
    s3/bucket_server_side_encryption.guard/check_s3_sse_kms_only                PASS
    s3/bucket_server_side_encryption.guard/check_s3_sse_kms_local_stack_only    PASS
    ```
    Congratulations! At this point the AWS CodePipeline should be able to deploy the S3 CDK application with no issues. Run the following command:
    :::code{showCopyAction=true showLineNumbers=false}
    git commit -a -m "fixed issues with S3 CDK and now complies with cfn-guard rules";git push
    :::
1. View the CodePipeline in your account. Instructions to do that is [here](https://docs.aws.amazon.com/codepipeline/latest/userguide/pipelines-view-console.html#pipelines-list-console.). Give it about a minute to restart. Verify that the cfn-guard rules have passed. At this point the pipeline should deploy the S3 CDK application.
1. Validate that the S3 bucket exists after the AWS CodePipeline completes. In the AWS Console browse over to S3. Look for a bucket with the prefix 'Bucket'.

## CodePipeline Cleanup
1. Attach the AWS Managed IAM policy AdministratorAccess to the IAM role **PolicyAsCodeRole**.
2. Change directory to the S3 CDK application:
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/cdk/app
    :::
3. Destroy the S3 CDK application by running:
    :::code{showCopyAction=true showLineNumbers=false}
    cdk destroy
    :::
    Answer 'y' to any prompts.
4. Change directory to the CodePipeline CDK application:
    :::code{showCopyAction=true showLineNumbers=false}
    cd ~/environment/policy-as-code/cdk/cicd
    :::
5. Destroy the CodePipeline CDK application:
    :::code{showCopyAction=true showLineNumbers=false}
    cdk destroy pac-pipeline
    :::
    Answer 'y' to all prompts (don't use --all with destroy as the pac-pipeline needs to be deleted first.)
6. Destroy the pac artificats by running
    :::code{showCopyAction=true showLineNumbers=false}
    cdk destroy pac
    :::
